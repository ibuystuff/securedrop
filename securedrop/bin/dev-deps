#!/bin/bash

export DISPLAY=:1

function run_xvfb() {
    setsid Xvfb :1 -screen 0 1024x768x24 -ac +extension GLX +render -noreset >& /tmp/xvfb.out || cat /tmp/xvfb.out
}

function run_redis() {
    setsid redis-server >& /tmp/redis.out || cat /tmp/redis.out
}

function run_x11vnc() {
    setsid x11vnc -display :1 -autoport 5901 -shared >& /tmp/x11vnc.out || cat /tmp/x11vnc.out
}

function urandom() {
    sudo rm /dev/random
    sudo ln -s /dev/urandom /dev/random
}

function append_to_exit() {
    local existing
    existing="$(trap | sed -n "/EXIT\$/s/^trap -- '\(.*\)' EXIT/\1/p")"
    trap "${existing:-true} ; $1" EXIT
}

function maybe_create_config() {
    journalist_config=/etc/securedrop/journalist-config.json
    source_config=/etc/securedrop/source-config.json
    sudo mkdir -p "$(dirname "$journalist_config")"
    sudo chown "$(id -u)":"$(id -g)" "$(dirname "$journalist_config")"
    if ! test -f "$journalist_config" ; then
        append_to_exit "rm -f $journalist_config"
        append_to_exit "rm -f $source_config"
        python - <<EOF
import json


cnf =  {
    "secret_key": "j2IcwRt6A2IsUeNEChZqp66cn7cpf/oP6rxO9d8M2E8=",
    "scrypt_id_pepper": "6KTTMPB+0RNV6TREDVD/7r8m/Pm5otK+7eyfaYWTm6s=",
    "scrypt_gpg_pepper": "GlAWMF9rk6eH671IPiu9pBu06PmvKR+LnC+wQI/jqkM=",
    "i18n": {
        "default_locale": "en_US",
        "supported_locales": ["ar", "de_DE", "es_ES", "en_US", "fr_FR", "it_IT", "nb_NO", "nl", "pt_BR", "tr", "zh_Hant"]
    },
    "journalist_key": "65A1B5FF195B56353CC63DFFCC40EF1228271441",
}

for config in ["$journalist_config", "$source_config"]:
    with open(config, "w") as f:
        f.write(json.dumps(cnf))
EOF
    fi
}

function run_sass() {
    sass --stop-on-error sass:static/css --style compressed "$@"
}

function reset_demo() {
    sudo mkdir -p /var/lib/securedrop/{store,keys,tmp}
    sudo chown -R "$(id -u)" /var/lib/securedrop
    cp ./tests/files/test_journalist_key.pub /var/lib/securedrop/keys
    gpg --homedir /var/lib/securedrop/keys --import /var/lib/securedrop/keys/test_journalist_key.pub >& /tmp/gpg.out || cat /tmp/gpg.out
    ./i18n_tool.py translate-messages --compile

    # remove previously uploaded custom logos
    rm -f /var/www/securedrop/static/i/custom_logo.png

    # create an empty database
    sqlite3 /var/lib/securedrop/db.sqlite .databases &> /dev/null

    ./manage.py reset
    ./create-dev-data.py
}
